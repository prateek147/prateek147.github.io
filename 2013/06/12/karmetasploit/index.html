
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>KARMETASPLOIT - Prateek Gianchandani</title>
  <meta name="author" content="Prateek Gianchandani">

  
  <meta name="description" content="KARMETASPLOIT Jun 12th, 2013 Posted by Prateek Gianchandani Wireless networks have become very common in today&#8217;s world, people are used to be &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://prateek147.github.io/2013/06/12/karmetasploit">
  <link href="/favicon.png" rel="icon">
  <link href='http://fonts.googleapis.com/css?family=Quicksand:300,400' rel='stylesheet' type='text/css'>
  <link href='http://fonts.googleapis.com/css?family=Open+Sans:400,300' rel='stylesheet' type='text/css'>
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Prateek Gianchandani" type="application/atom+xml">
  <script src="/js/jquery.js"></script>
  <script src="/js/bootstrap-collapse.js"></script>
  <script src="/js/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/lib/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/js/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js" type="text/javascript"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.8.16/jquery-ui.min.js" type="text/javascript"></script>
<style>
body {
    -moz-transform: scale(0.9, 0.9); /* Moz-browsers */
    zoom: 0.2; /* Other non-webkit browsers */
    zoom: 20%; /* Webkit browsers */
    transform: scale(1.9);
    transform-origin: 90% 90%;
}
</style>
  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-41877509-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <div class="navbar navbar-inverse navbar-static-top">
  	<div class="navbar-inner">
  	  <div class="container">
        <a class="btn btn-navbar" data-toggle="collapse" data-target=".navbar-responsive-collapse">
          <span class="fui-menu-24"></span>
        </a>
  	  	<div class="nav-collapse collapse navbar-responsive-collapse" style="height:0;">
  	      <ul class="nav">
    
        <li ><a href="/index.html">Home</a></li>
    
        <li ><a href="/security/">Security</a></li>
    
        <li ><a href="/ios/">iOS Development</a></li>
    
        <li ><a href="/everest/">Everest</a></li>
    
        <li ><a href="/archives/index.html">Archives</a></li>
    
        <li ><a href="http://damnvulnerableiosapp.com">DVIA</a></li>
    
        <li ><a href="/about/">About Me</a></li>
    
        <li ><a href="/hire-me/">Hire Me</a></li>
    
</ul>

<ul class="nav pull-right">
    
    <li><a href="http://github.com/prateek147" title="Github Profile"><i class="icon-github-sign social-navbar"></i></a></li>
    
    
    <li><a href="http://linkedin.com/in/prateekgianchandani" title="Linkedin Profile"><i class="icon-linkedin-sign social-navbar"></i></a></li>
    
    
    <li><a href="http://twitter.com/prateekg147" title="Twitter Profile"><i class="icon-twitter-sign social-navbar"></i></a></li>
    
    
    
    <li><a href="http://facebook.com/prateek.gianchandani" title="Facebook Profile"><i class="icon-facebook-sign social-navbar"></i></a></li>
    
</ul>

  	    </div>
  	  </div>
  	</div>
  </div>
  <div class="container" id="main">
    <div class="span12">
      <div class="row-fluid">
        <div id="content">
          <div>
<article class="hentry" role="article">
  

  <header>
  <div class="jumbotron">
    KARMETASPLOIT
	<h5>








  


<i class="icon-calendar-empty"></i> <time datetime="2013-06-12T04:49:00+04:00" pubdate data-updated="true">Jun 12<span>th</span>, 2013</time></h5>
  <h4>
  

<p>Posted by <a href="http://highaltitudehacks.com/about/">Prateek Gianchandani</a></p>
<h4>
  </div>
</header>
  <div class="row-fluid">
    <div class="span12">
      <p>Wireless networks have become very common in today&#8217;s world, people are used to be connected to wireless networks in office, home, coffee shops etc. In order to facilitate the process of connecting to the wireless network, most of the operating systems often remember the previous networks connected to (often stored in Preferred Networks List) and send continuous probes looking for these networks. Once the network is found, the system automatically connects to the network. If more than one of the probed networks is found, it connects to the network with the highest signal strength (though it may vary sometimes on the operating system used).Since these clients send continuous probes, any hacker within the radio frequency range can listen passively and see the networks the client is probing for. Because of the vulnerabilities in the implementation of the algorithms for connecting to previous networks, it is possible for an attacker to set up a custom station (Access point) and have the victim connect to it. Once the victim is connected to the Fake AP the attacker has IP-level connectivity to the victim and can launch a bunch of attacks against the victim.</p>




<!-- more -->




<p>Dino Dai Zovi ann Shane Macaulay, 2 security researchers, wrote a set of wireless security tools developed as a Proof of concept for this vulnerability and called it Karma. It was later integrated with Metasploit and called Karmetasploit, so when a victim connects to the fake AP, karmetasploit launches all the suitable attacks available in the Metasploit framework against the vicitm. Karmetasploit also implements various evil services like DNS, POP3, FTP, SMB etc and responds to the client&#8217;s requests for these services. That way, we can also capture passwords and other credentials. In this article we will look at a demo of Karmetasploit in action.</p>




<h2>Configuration</h2>




<p>The first thing is to download the Karma resource file from Offensive security website as shown in the image below.</p>


<p><img src="/images/posts/Karmetasploit//1.png" width="764" height="405" alt="1"></p>

<p>The next step is to set up a DHCP server in place. This is because clients will expect an IP-address to be handed over to them when they connect to the access point. We will need to install the dhcp3-server utility, and also specify a custom configuration file. Set up the configuration file as shown in the figure below.</p>


<p><img src="/images/posts/Karmetasploit//2 actual.png" width="747" height="247" alt="2 Actual"></p>

<p>a) At the start of the configuration file is the place for setting your global parameters, as we can see the domain name server address has been set to 10.0.0.1. Some things to note about the settings is that some lines start with the option keyword whereas some do not. The lines that start with the &#8220;option&#8221; keyword correspond to the options for the DHCP server, whereas the lines that do not start with the option keyword can either control the behaviour of the DHCP server, or specify some client parameters that are not optional in the DHCP protocol.</p>




<p>b) In the second and third line we have set up the default and the maximum lease time, this actually specifies the time after which the DHCP server will reclaim and reallocate the IP addresses. Usually the lease renews itself halfway through the set time. For e.g if the lease time is set to 2 hours, the lease will renew itself after every 1 hour. In this case the default and the maximum lease time has been set to 1 minute and 1.2 minutes respectively.</p>




<p>c) The fourth line states &#8220;ddns-update-style none;&#8221;, this basically specifies the dynamic dns update style to be used. In this case we have set it to none.</p>




<p>d) In the fifth line the term &#8220;authoritative&#8221; means that the DHCP server is the official DHCP server for the local network. Obviously we should set it to authoritative to avoid any sort of suspicion.</p>




<p>e) The sixth statement &#8220;log-facility local7&#8221; specifies the DHCP server to do all its logging on the specified log facility (in this case local7). There are a number of log facilities available but not all log facilities are available on all systems. Some of the popular log facilities include auth, daemon, security, syslog etc.</p>




<p>f) In the next line the configuration for an internal subnet is set inside curly braces, this means that the options inside the braces specify only to the systems with subnet 10.0.0.1 and netmask 255.255.255.0 .The range parameter specifies the range in which the IP-Addresses will be handed over to the client. In this case the clients connected to the Fake AP will be assigned the IP-addresses in the range 10.0.0.25-10.0.0.254. We have also set up the domain name server&#8217;s and the router&#8217;s IP-address inside the curly braces.</p>


<p></p>

<p>Let&#8217;s have a quick look at the karma resource file, type &#8220;cat karma.rc&#8221; to show the contents of the file.</p>


<p><img src="/images/posts/Karmetasploit//3 actual.png" width="772" height="499" alt="3 Actual"/></p>

<p><img src="/images/posts/Karmetasploit//4 actual.png" width="770" height="491" alt="4 Actual"/></p>

<p>First of all it loads the database &#8220;db_connect postgres:toor@127.0.0.1/msfbook&#8221; and then loads the browswer_autopwn server, the browser_autopwn is useful in launching a number of browser based exploits against the client as soon as the client opens up the browser. It then sets the server&#8217;s IP, port and the URL. After that, a number of servers are started on different ports. One of the notable ones is the fakedns server which listens on UDP port 53 (which is used by default for handling DNS requests), receives the requests from the clients for different domain names and hands out an incorrect IP-address for that domain.</p>




<h2>Launching the Attack</h2>




<p>Now it&#8217;s time to set up the Fake-AP, we need a good wireless card for that, i am using &#8220;Alfa AWUS036H&#8221; 1000mW USB Wireless WiFi Adapter, it&#8217;s a very popular wireless card and supports packet injection. One of the other cool things about it is that Backtrack already has drivers installed for this card and hence we don&#8217;t need to do any custom setup or installation. Just plug it in and it will work. We will start by setting our wireless card in monitor mode, which allows us to sniff all the packets in our RF range, hence we can see what networks the clients nearby are probing for. Type in the &#8220;iwconfig&#8221; command to see the wireless interface. Type in &#8220;airmon-ng start interface-name&#8221; to set up the card in monitor mode.As we can see a virtual interface named mon0 has been created on top of wlan0 interface and it is currently in monitor mode.</p>


<p><img src="/images/posts/Karmetasploit//5.png" width="773" height="438" alt="5"></p>

<p>Let&#8217;s do a simple hack now to increase the signal strength of our wireless card. This is because we want the nearby clients to connect to us and hence our card should provide good signal strength which will increase the chances of clients connecting to us. Different countries have different range of power levels under which the wireless card will have to operate, for e.g in my case (INDIA), the maximum allowed strength for a wireless card is 20 DBm (approximately 100mW), however my card supports upto 30 DBm (1000 mW). The command &#8220;iw reg set IN&#8221; sets the regulatory domain to India (IN).</p>


<p><img src="/images/posts/Karmetasploit//6.png" width="773" height="206" alt="6"></p>

<p>Linux however allows us to change the regulatory domain, and hence we can bypass the regulatory restriction. But which country should we change the regulatory domain to? One of the answers is &#8220;Bolivia&#8221;, as it allows our card to operate at the maximum power level i.e 30 DBm. Type in the commands as shown in the figure below to set the transmission power to 30DBm</p>


<p><img src="/images/posts/Karmetasploit//7.png" width="769" height="203" alt="7"></p>

<p>As we can see the tx-power is now set to 30 DBm.</p>




<p>We will now set up our Fake AP. We will use the utility  airbase-ng which is available by default in Backtrack. Type in the following command as shown in the figure below to set up the Fake AP. The name of the AP is set by the -e option, the -P option asks airbase-ng to respond to all probes, the &#8220;-C 30&#8221; option asks airbase-ng to send Beacon frames with the ESSID of all the probed networks after every 30 seconds, so that a client in the RF range probing for the same network will be fooled and will connect to the Fake AP set up by the attacker if we are able to provide a better signal strength than the actual network. Finally we specify the interface name which is mon0.</p>


<p><img src="/images/posts/Karmetasploit//8.png" width="774" height="109" alt="8"></p>

<p>We can also see that airbase-ng has created a virtual interface named &#8220;at0&#8221;. This interface will be used by Karmetasploit.</p>




<p>We can verify from airodump-ng that a network named &#8220;InfoSecInstitute&#8221; has been created, also in the lower section under the probes section we can also see that some clients are probing for networks and the name of the network is given under the Probes section. Type in the command &#8220;airodump-ng mon0&#8221; to see a similar output, where mon0 is the interface which is currently set up in monitor mode. </p>


<p><img src="/images/posts/Karmetasploit//9.png" width="771" height="390" alt="9"></p>

<p>The next step is to set up the DHCP server. First install the dhcp3-server by using the following command as shown below, as you can see i already have the latest version. Also don&#8217;t forget to backup the original dhcpd.conf file when creating a new one for our DHCP server.</p>


<p><img src="/images/posts/Karmetasploit//10.png" width="745" height="138" alt="10"></p>

<p>Now we are going to start up the DHCP server, first we assign an IP-address and a netmask to the at0 interface and set it up. Next we start the DHCP server by typing the command as shown in the figure below. As we can see from the command that we are passing our previously created dhcpd.conf file as an input.</p>


<p><img src="/images/posts/Karmetasploit//11.png" width="746" height="229" alt="11"></p>

<p>To verify that the DHCP server is running, let&#8217;s do a quick &#8220;ps aux | grep dhcpd &#8221; and check the output. As we can see the dhcpd service is up and running. </p>


<p><img src="/images/posts/Karmetasploit//12.png" width="746" height="196" alt="12"></p>

<p>Also it would be a good idea to see the messages log file to see the IP addresses being handed out when the DHCP server is responding to our clients. It is also evident from the output that the dhcpd3 service is listening for requests.</p>


<p><img src="/images/posts/Karmetasploit//13.png" width="745" height="188" alt="13"></p>

<p>Now it&#8217;s time to start up Karmetasploit, go to the terminal and type in &#8220;msfconsole -r karma.rc&#8221;. We can see that the karma resource file is being given as an input to Metasploit. You will get a somewhat similar output as shown in the figure below.</p>


<p><img src="/images/posts/Karmetasploit//14.png" width="781" height="502" alt="14"></p>

<p>In this image, Karmetasploit is creating different tables to store various info about the client like credentials, email address etc.</p>


<p><img src="/images/posts/Karmetasploit//15.png" width="784" height="526" alt="15"></p>

<p>In this image, Karmetasploit is setting LHOST to 10.0.0.1, and setting other options like Server Port (SRVPORT) , path of the url (URIPATH) etc. It is also starting up services like POP3 , Ftp .</p>


<p><img src="/images/posts/Karmetasploit//16.png" width="782" height="446" alt="16"></p>

<p>Here it is loading all the autopwn exploits, and setting up their corresponding payloads. Most of these payloads are reverse payloads, which can also work if the victim is behind a NAT, as the connection is made being from the client to the attacker and not from the attacker to the client.</p>


<p><img src="/images/posts/Karmetasploit//17.png" width="781" height="344" alt="17"></p>

<p>Finally, a payload handler is started by Karmetasploit, and it starts listening for connections from the client. If all goes well, you will get a &#8220;Server started&#8221; message in the end. </p>




<p>It&#8217;s now time for the client to connect to our Fake Access point, we can wait for some time for the client to connect or we can simply carry out  a deauthentication attack against the client. After being deauthenticated from the network the client will again try to reconnect to the network, however if our signal strength is more, it will connect to our Fake AP as our Fake AP will be the first to respond to their probes. The figure below shows how to carry out a broadcast deauthentication attack. Note that it is essential to first put your card on the same channel as the access point. This attack will basically tell all the clients associated with the Access point to disconnect from it. Hence we have to give the bssid of the access point using the &#8220;-a&#8221; option which we can find easily using Airodump.</p>


<p><img src="/images/posts/Karmetasploit//18.png" width="782" height="505" alt="18"></p>

<p>Once the client connects to us, an IP-address will be handed over to it from our DHCP server, we can find this out by looking at the logs file, as we can see, a number of IP-addresses are being handed over to clients that connect to our Fake AP.</p>


<p><img src="/images/posts/Karmetasploit//19.png" width="782" height="502" alt="19"></p>

<p>Also in the Airbase-ng output we can also see that some clients have connected to us.</p>


<p><img src="/images/posts/Karmetasploit//20.png" width="782" height="130" alt="20"></p>

<p>When the use opens up his browser, all he sees is this page showing the Loading sign, this page however can be modified by the hacker to make a custom web page as the html file is present in the Metasploit directory. In this case i connected 2 systems running Mac OS and Windows 7 respectively.</p>


<p><img src="/images/posts/Karmetasploit//21.png" width="784" height="504" alt="21"></p>

<p>In the background however, a lot of action is happening as is evident from the karmetasploit output below. We can see two Javascript reports in the output. Karma has identified the operating systems running on these systems as well as the browser and their versions. Based on that it has identified some exploits and is starting to drop the payloads on the systems. In this case i am using fully patched Mac OS and Windows 7 systems, hence it is not able to get a shell on the system.</p>


<p><img src="/images/posts/Karmetasploit//22.png" width="782" height="504" alt="22"></p>

<p>The results are different when working with an unpatched windows box, we get a meterpreter session on the system, also note that we must migrate to another process as soon as we get a shell because the user may close the browser and hence our connectivity may be lost.</p>


<p><img src="/images/posts/Karmetasploit//23.png" width="776" height="159" alt="23"></p>

<h2>Conclusion</h2>




<p>Wireless networks have become very common these days, however due to the vulnerabilities in the algorithms used to connect to a wireless network, an attacker can force a client to connect to a Fake AP after which the attacker will have IP-level connectivity to the client and can launch a bunch of exploits against it. Karma was developed as a POC for this vulnerability and later integrated with the Metasploit framework and called Karmetasploit. Karmetasploit uses the vulnerability in the 802.11 protocols and the exploits present in metasploit framework to carry out a directed attack at the victim. One of the good features about this kind of attack is that it will even work against secured wireless networks.</p>




<p>This article was originally published on the <a href="http://resources.infosecinstitute.com/">resources</a> page at <a href="http://infosecinstitute.com/">Infosec Institute</a>. For more information, please visit my author <a href="http://resources.infosecinstitute.com/author/prateek/">page</a>.</p>




    </div>
  </div>



  <footer>
    <hr>
    
    <div class="row-fluid">
      
      <div class="span6">
        <p class="meta">
        
        



  <a href="//categories/metasploit/"><span class="badge">metasploit</span></a>

  <a href="//categories/security/"><span class="badge">security</span></a>




        </p>
      </div>
      
      <div class="span6 social-sharing">
        <div class="sharing">
  <div class="addthis_toolbox addthis_default_style ">
  
  <a class="addthis_button_facebook_like" fb:like:layout="button_count"></a>
  
  
  <a class="addthis_button_tweet"></a>
  
  
  <a class="addthis_counter addthis_pill_style"></a>
  </div>
  <script type="text/javascript" src="http://s7.addthis.com/js/250/addthis_widget.js#pubid="></script>
</div>

      </div>
      
      
    </div>
    
    <div class="row-fluid">
      <div class="span12">
        <p class="meta">
          
            <a class="basic-alignment left" href="/2013/06/12/abusing-ip-protocols-to-create-covert-channels-when-penetration-testing" title="Previous Post: Abusing IP Protocols to Create Covert Channels when Penetration Testing">&laquo; Abusing IP Protocols to Create Covert Channels when Penetration Testing</a>
          
          
            <a class="basic-alignment right" href="/2013/06/12/hacking-web-authentication-part-1" title="Next Post: Hacking Web Authentication – Part 1">Hacking Web Authentication – Part 1 &raquo;</a>
          
        </p>
      </div>
    </div>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>



        </div>
      </div>
      <div class="row-fluid">
        <footer class="footer-page" role="contentinfo">
          <p>
  Copyright &copy; 2014 - Prateek Gianchandani -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span> - Theme by <a href="http://alexgaribay.com">Alex Garibay</a>
</p>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-41877509-1', 'highaltitudehacks.com');
  ga('send', 'pageview');

</script>

<!-- Start of StatCounter Code for Default Guide -->
<script type="text/javascript">
var sc_project=9078428; 
var sc_invisible=1; 
var sc_security="a08bf0bd"; 
var scJsHost = (("https:" == document.location.protocol) ?
"https://secure." : "http://www.");
document.write("<sc"+"ript type='text/javascript' src='" +
scJsHost+
"statcounter.com/counter/counter.js'></"+"script>");
</script>
<noscript><div class="statcounter"><a title="web analytics"
href="http://statcounter.com/" target="_blank"><img
class="statcounter"
src="http://c.statcounter.com/9078428/0/a08bf0bd/1/"
alt="web analytics"></a></div></noscript>
<!-- End of StatCounter Code for Default Guide -->
        </footer>
      </div>
    </div>
  </div>
  

<script type="text/javascript">
      var disqus_shortname = 'highaltitudehacks';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://prateek147.github.io/2013/06/12/karmetasploit';
        var disqus_url = 'http://prateek147.github.io/2013/06/12/karmetasploit';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id; js.async = true;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>





  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
